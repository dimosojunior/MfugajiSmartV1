import {
  StyleSheet, TextInput, ActivityIndicator, Pressable, Text, ScrollView, View, Image,
  TouchableOpacity, Modal, Dimensions
} from 'react-native';
import React, { useState, useEffect } from 'react';
import { globalStyles } from '../Styles/GlobalStyles';
import { EndPoint } from "../Constant/links";
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Ionicons } from '@expo/vector-icons';
import COLORS from '../Constant/colors';

const { width, height } = Dimensions.get('window');

const VyakulaVyote = ({ navigation, route }) => {
  const { KukuId, id } = route.params;
  const UmriwaKukuId = id;

  const [showAlert, setShowAlert] = useState(false);
  const [alertMessage, setAlertMessage] = useState("");
  const [input, setInput] = useState('');
  const [modalVisible, setModalVisible] = useState(false);
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [cart, setCart] = useState([]);
  const [userToken, setUserToken] = useState('');
  const [shouldReload, setShouldReload] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const InitialQuantityValue = "1";
  const [quantity, setQuantity] = useState(InitialQuantityValue);
  const [queryset, setQueryset] = useState([]);
  const [current_page, setcurrent_page] = useState(1);
  const [isLoading, setIsLoading] = useState(false);
  const [loading, setLoading] = useState(false);
  const [endReached, setEndReached] = useState(false);
  const [isPending, setPending] = useState(true);
  const [selectedProductId, setSelectedProductId] = useState(null); // For changing background color

  const getItems = () => {
    if (endReached) {
      setLoading(false);
      setIsLoading(false);
      setPending(false);
      return;
    } else {
      setIsLoading(true);
      const url = EndPoint + `/GetAllVyakulaView/?page=${current_page}&page_size=2`;
      fetch(url)
        .then((res) => res.json())
        .then((data) => {
          if (data.queryset.length > 0) {
            setQueryset([...queryset, ...data.queryset]);
            setIsLoading(false);
            setLoading(false);
            setcurrent_page(current_page + 1);
            setPending(false);
          } else {
            setIsLoading(false);
            setEndReached(true);
            setLoading(false);
            setPending(false);
          }
        });
    }
  };

  const handleScroll = (event) => {
    const { layoutMeasurement, contentOffset, contentSize } = event.nativeEvent;
    const scrollEndY = layoutMeasurement.height + contentOffset.y;
    const contetHeight = contentSize.height;
    if (scrollEndY >= contetHeight - 50) {
      getItems();
    }
  };

  useEffect(() => {
    setLoading(true);
    getItems();
    checkLoggedIn();
  }, []);

  const checkLoggedIn = async () => {
    const token = await AsyncStorage.getItem('userToken');
    setUserToken(token);
  };

  const addCartItem = async () => {
    if (!selectedProduct) {
      setPending(false);
      showAlertFunction("Tafadhali, chagua aina ya chakula ulichonacho");
      return;
    }

    setPending(true);
    const productPrice = selectedProduct.price;
    const itemPrice = productPrice * parseInt(quantity);
    setModalVisible(false);
    setIsModalVisible(false);

    try {
      const response = await axios.post(
        EndPoint + '/VyakulaCart/',
        {
          product: selectedProduct.id,
          quantity: parseInt(quantity),
        },
        {
          headers: {
            Authorization: `Token ${userToken}`,
          },
        }
      );

      setPending(false);
      showAlertFunction("Umefanikiwa kuchagua chakula");
      setSelectedProductId(selectedProduct.id); // Set selected product id

      const newItem = {
        id: response.data.id,
        product: selectedProduct,
        quantity: parseInt(quantity),
        price: itemPrice,
      };

      setSelectedProduct(null);
      setQuantity(InitialQuantityValue);
    } catch (error) {
      setPending(false);
      showAlertFunction("Imeshindikana kuchagua chakula");
    }
  };

  const showAlertFunction = (message) => {
    setAlertMessage(message);
    setShowAlert(true);
  };

  const hideAlert = () => {
    setShowAlert(false);
  };

  const formatToThreeDigits = (number) => {
    if (number !== null) {
      return number.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2,
        minimumIntegerDigits: 1,
      });
    }
    return null;
  };

  const CartCard = ({ item }) => {
    if (input === "" || item.product_name.toLowerCase().includes(input.toLowerCase())) {
      return (
        <Pressable
          style={[
            globalStyles.VyakulaCartItemsContainer,
            { backgroundColor: selectedProductId === item.id ? 'red' : 'white' }
          ]}
        >
          <View style={globalStyles.VyakulaLeftCartItemsContainer}>
            <Text style={globalStyles.VyakulaItemNameCartItemsText}>
              {item.product_name}
            </Text>
            <TouchableOpacity
              onPress={() => {
                setSelectedProduct(item);
                setModalVisible(true);
                setIsModalVisible(true);
              }}
              style={globalStyles.VyakulaAddButtonContainerCartItems}
            >
              <Text style={globalStyles.VyakulaAddButtonTextCartItems}>
                Chagua
              </Text>
            </TouchableOpacity>
          </View>
          <Pressable style={globalStyles.VyakulaImageContainerCartItems}>
            <Text style={globalStyles.VyakulaPriceCartItemsText}>
              Bei (Kilo 1): Tsh. {formatToThreeDigits(item.price)}/=
            </Text>
            {item.ProductImage ? (
              <Image
                style={globalStyles.VyakulaImageCartItems}
                source={{ uri: EndPoint + '/' + item.ProductImage }}
              />
            ) : (
              <Image
                style={globalStyles.VyakulaImageCartItems}
                source={require('../assets/500.png')}
              />
            )}
          </Pressable>
        </Pressable>
      );
    }
    return null;
  };

  return (
    <>{!isPending ? (
      <View style={[
        globalStyles.container,
        {
          backgroundColor: isModalVisible ? COLORS.black : COLORS.white,
          opacity: isModalVisible ? 0.1 : 1
        }
      ]}>
        <ScrollView
          keyboardShouldPersistTaps="handled"
          showsVerticalScrollIndicator={false}
          onScroll={handleScroll}
          scrollEventThrottle={16}
        >
          <View style={globalStyles.searchbarOtherPages}>
            <View style={globalStyles.searchbarIconContainerOtherPages}>
              <Ionicons name="search-outline"
                size={25}
                color={COLORS.black}
                style={globalStyles.AppIConHomeScreenOtherPages}
              />
            </View>
            <View style={globalStyles.searchbarInputContainerOtherPages}>
              <TextInput
                value={input}
                onChangeText={(text) => setInput(text)}
                placeholder="Tafuta"
                placeholderTextColor='black'
                style={globalStyles.AppInputHomeScreenOtherPages}
              />
            </View>
          </View>

          <Text style={globalStyles.AppChaguaHudumaTextHomeScreen}>
            Chagua chakula na kiasi ulichonacho
          </Text>

          <Text style={[globalStyles.AppChaguaHudumaTextHomeScreen, { color: 'green' }]}>
            Vyakula Vya Bidhaa Zote
          </Text>

          <View style={globalStyles.VyakulaContainer}>
            {queryset.length > 0 ? (
              queryset
                .filter((item) => item.FoodGroup === KukuId || KukuId === 1)
                .map((item, index) => (
                  <CartCard key={index} item={item} />
                ))
            ) : (
              <View style={globalStyles.VyakulaNotFoundContainer}>
                <Text style={globalStyles.VyakulaNotFoundText}>
                  Hakuna vyakula vinavyolingana na utafutaji wako.
                </Text>
              </View>
            )}
          </View>
        </ScrollView>
        {isLoading && (
          <ActivityIndicator
            size="large"
            color={COLORS.primary}
            style={globalStyles.activityIndicator}
          />
        )}
        <Modal
          visible={modalVisible}
          animationType='slide'
          transparent={true}
        >
          <View style={globalStyles.modalContainer}>
            <View style={globalStyles.modalContent}>
              <Text style={globalStyles.modalTitle}>Ongeza kwenye Kikapu</Text>
              <Text style={globalStyles.modalProductName}>
                {selectedProduct?.product_name}
              </Text>
              <TextInput
                value={quantity}
                onChangeText={(text) => setQuantity(text)}
                keyboardType='numeric'
                style={globalStyles.modalInput}
              />
              <TouchableOpacity
                onPress={addCartItem}
                style={globalStyles.modalButton}
              >
                <Text style={globalStyles.modalButtonText}>Ongeza</Text>
              </TouchableOpacity>
              <TouchableOpacity
                onPress={() => setModalVisible(false)}
                style={[globalStyles.modalButton, globalStyles.modalCancelButton]}
              >
                <Text style={globalStyles.modalButtonText}>Funga</Text>
              </TouchableOpacity>
            </View>
          </View>
        </Modal>
      </View>
    ) : (
      <ActivityIndicator size="large" color={COLORS.primary} style={globalStyles.activityIndicator} />
    )}
    </>
  );
};

export default VyakulaVyote;
